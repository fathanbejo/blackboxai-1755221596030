<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suite Aplikasi Sekolah</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="global.css">
    <style>
        .user-status-bar {
            text-align: right;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: var(--text-dark);
        }
        .user-status-bar a {
            color: var(--danger-color);
            text-decoration: none;
            font-weight: 600;
            margin-left: 15px;
            padding: 5px 10px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .user-status-bar a:hover {
            background-color: #fee2e2;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div id="user-status-bar" class="user-status-bar"></div>

        <header class="dashboard-header">
            <img src="https://mia02sgs.sch.id/wp-content/uploads/2024/01/cropped-Tagline-1.png" alt="Logo Sekolah" class="logo" id="schoolLogo">
            <h1 id="headerLine1">Suite Aplikasi Administrasi</h1>
            <p id="headerLine3">MI ALMAARIF 02 SINGOSARI</p>
        </header>

        <main class="dashboard-grid">
            <div class="app-card">
                <div class="app-card-header">
                    <div class="app-icon" style="background-color: #2E7D32;"><i class="fas fa-edit"></i></div>
                    <div class="app-info">
                        <h3>Formulir Dinamis</h3>
                        <p>Entri dan kelola data siswa secara fleksibel.</p>
                    </div>
                </div>
                <div class="app-links">
                    <a href="form-entri.html">Formulir Entri <i class="fas fa-chevron-right"></i></a>
                    <a href="form-grid.html">Lihat Data Grid <i class="fas fa-chevron-right"></i></a>
                    <a href="form-settings.html" class="admin-only-link" style="display: none;">Pengaturan Form <i class="fas fa-chevron-right"></i></a>
                </div>
            </div>

            <div class="app-card">
                <div class="app-card-header">
                    <div class="app-icon" style="background-color: #0d9488;"><i class="fas fa-calendar-check"></i></div>
                    <div class="app-info">
                        <h3>Aplikasi Perizinan</h3>
                        <p>Catat dan pantau absensi siswa dengan mudah.</p>
                    </div>
                </div>
                <div class="app-links">
                    <a href="izin.html">Formulir Izin <i class="fas fa-chevron-right"></i></a>
                    <a href="izin-dasbor.html">Dasbor Admin <i class="fas fa-chevron-right"></i></a>
                </div>
            </div>

            <div class="app-card">
                 <div class="app-card-header">
                    <div class="app-icon" style="background-color: #17a2b8;"><i class="fas fa-calendar-alt"></i></div>
                    <div class="app-info">
                        <h3>Kalender Akademik</h3>
                        <p>Lihat agenda bulanan dan tahunan madrasah.</p>
                    </div>
                </div>
                <div class="app-links">
                    <a href="kalender.html">Kalender Bulanan <i class="fas fa-chevron-right"></i></a>
                    <a href="kaldik.html">Tabel Agenda Tahunan <i class="fas fa-chevron-right"></i></a>
                </div>
            </div>

            <div class="app-card">
                 <div class="app-card-header">
                    <div class="app-icon" style="background-color: #5856d6;"><i class="fas fa-users"></i></div>
                    <div class="app-info">
                        <h3>Daftar Hadir Rapat</h3>
                        <p>Digitalisasi absensi rapat dengan tanda tangan.</p>
                    </div>
                </div>
                <div class="app-links">
                    <a href="rapat-entri.html">Form Kehadiran <i class="fas fa-chevron-right"></i></a>
                    <a href="rapat-rekap.html">Rekap Rapat <i class="fas fa-chevron-right"></i></a>
                </div>
            </div>

            <div class="app-card admin-only-link" style="display: none;">
                 <div class="app-card-header">
                    <div class="app-icon" style="background-color: #64748b;"><i class="fas fa-cogs"></i></div>
                    <div class="app-info">
                        <h3>Pengaturan Global</h3>
                        <p>Atur branding, logo, dan kop surat PDF.</p>
                    </div>
                </div>
                <div class="app-links">
                    <a href="admin.html">Buka Pengaturan <i class="fas fa-chevron-right"></i></a>
                </div>
            </div>
             <div class="app-card admin-only-link" style="display: none;">
                 <div class="app-card-header">
                    <div class="app-icon" style="background-color: #be123c;"><i class="fas fa-user-shield"></i></div>
                    <div class="app-info">
                        <h3>Manajemen Pengguna</h3>
                        <p>Tambah, edit, dan hapus akun pengguna.</p>
                    </div>
                </div>
                <div class="app-links">
                    <a href="admin.html#user-management-section">Kelola Pengguna <i class="fas fa-chevron-right"></i></a>
                </div>
            </div>
        </main>
    </div>
    <script type="module">
        import { apiCall } from './api-helper.js';
        import { checkSession, logout } from './auth-helper.js';
        
        async function loadBranding() {
            try {
                const settings = await apiCall('getGlobalSettings', 'GET');
                if (settings.logo_path) {
                    document.getElementById('schoolLogo').src = settings.logo_path.startsWith('http') ? settings.logo_path : `${settings.logo_path}?t=${new Date().getTime()}`;
                }
                if (settings.dashboard_title) {
                    document.getElementById('headerLine1').textContent = settings.dashboard_title;
                }
                if (settings.dashboard_subtitle) {
                    document.getElementById('headerLine3').textContent = settings.dashboard_subtitle;
                }
            } catch (error) {
                console.warn('Could not load global branding settings:', error);
            }
        }
        
        async function initializeDashboard() {
            const user = await checkSession();
            const userStatusBar = document.getElementById('user-status-bar');

            if (user) {
                userStatusBar.innerHTML = `
                    <span>Selamat datang, <strong>${user.nama_lengkap || user.username}</strong>!</span>
                    <a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> Logout</a>
                `;
                document.getElementById('logout-button').addEventListener('click', (e) => {
                    e.preventDefault();
                    logout();
                });

                // Tampilkan link/kartu khusus admin
                if (user.role === 'admin') {
                    document.querySelectorAll('.admin-only-link').forEach(el => el.style.display = 'block');
                } else if (user.role === 'operator') {
                    // Operator bisa melihat pengaturan form dinamis
                    const formSettingsLink = document.querySelector('a[href="form-settings.html"]');
                    if (formSettingsLink) formSettingsLink.style.display = 'flex';
                }
            } else {
                // Jika tidak ada user, sembunyikan link admin
                 document.querySelectorAll('.admin-only-link').forEach(el => el.style.display = 'none');
                 const formSettingsLink = document.querySelector('a[href="form-settings.html"]');
                 if (formSettingsLink) formSettingsLink.style.display = 'none';

                userStatusBar.innerHTML = `<a href="login.html" style="color: var(--primary-color);">Login <i class="fas fa-sign-in-alt"></i></a>`;
            }
            loadBranding();
        }

        initializeDashboard();
    </script>
</body>
</html>